---
# tasks file for vault-policies

- name: Ensure Vault token is available
  fail:
    msg: "Vault root token is required for policy management"
  when: vault_root_token is not defined or vault_root_token == ""

- name: Create policies directory locally
  file:
    path: "{{ vault_policies_source_dir }}"
    state: directory
    mode: "0755"
  delegate_to: localhost
  run_once: true
  when: vault_policies_create_default | default(true)

- name: Create default policy files
  copy:
    content: "{{ item.content }}"
    dest: "{{ vault_policies_source_dir }}/{{ item.name }}{{ vault_policy_file_extension }}"
    mode: "0644"
  loop: "{{ vault_default_policies }}"
  delegate_to: localhost
  run_once: true
  when:
    - vault_policies_create_default | default(true)
    - vault_default_policies is defined

- name: Find policy files in policies directory
  find:
    paths: "{{ vault_policies_source_dir }}"
    patterns: "*{{ vault_policy_file_extension }}"
    file_type: file
  register: policy_files
  delegate_to: localhost
  when: vault_policies_source_dir is defined

- name: Read policy files content
  slurp:
    src: "{{ item.path }}"
  register: policy_file_contents
  loop: "{{ policy_files.files }}"
  delegate_to: localhost
  when: policy_files.files is defined

- name: Combine all policies
  set_fact:
    all_policies: >-
      {{
        (vault_default_policies | default([])) +
        (policy_file_contents.results | default([]) | 
         map(attribute='content') | 
         map('b64decode') | 
         zip(policy_files.files | default([]) | map(attribute='path') | map('basename') | map('regex_replace', vault_policy_file_extension + '$', '')) |
         map('zip', ['content', 'name']) | 
         map('items2dict') | 
         list) +
        (vault_custom_policies | default([]))
      }}

- name: Get existing policies
  uri:
    url: "{{ vault_addr }}/v1/sys/policies/acl"
    method: LIST
    headers:
      X-Vault-Token: "{{ vault_root_token }}"
    status_code: 200, 404
    validate_certs: "{{ not vault_skip_verify | default(true) }}"
  register: existing_policies

- name: Display existing policies
  debug:
    msg: "Existing policies: {{ existing_policies.json.data.keys | default([]) }}"
  when: existing_policies.json is defined and existing_policies.json.data is defined

- name: Validate policy syntax (dry-run)
  uri:
    url: "{{ vault_addr }}/v1/sys/policies/acl/{{ item.name }}"
    method: PUT
    headers:
      X-Vault-Token: "{{ vault_root_token }}"
    body_format: json
    body:
      policy: "{{ item.content }}"
    status_code: 204, 400
    validate_certs: "{{ not vault_skip_verify | default(true) }}"
  loop: "{{ all_policies }}"
  register: policy_validation
  when:
    - vault_policies_validate_syntax | default(true)
    - all_policies is defined
  check_mode: yes
  ignore_errors: yes

- name: Display policy validation results
  debug:
    msg: "Policy '{{ item.item.name }}' validation: {{ 'PASSED' if item.status == 204 else 'FAILED' }}"
  loop: "{{ policy_validation.results | default([]) }}"
  when: policy_validation.results is defined

- name: Fail on policy validation errors
  fail:
    msg: "Policy validation failed for: {{ policy_validation.results | selectattr('status', 'ne', 204) | map(attribute='item.name') | list }}"
  when:
    - vault_policies_validate_syntax | default(true)
    - policy_validation.results is defined
    - policy_validation.results | selectattr('status', 'ne', 204) | list | length > 0

- name: Create/Update policies
  uri:
    url: "{{ vault_addr }}/v1/sys/policies/acl/{{ item.name }}"
    method: PUT
    headers:
      X-Vault-Token: "{{ vault_root_token }}"
    body_format: json
    body:
      policy: "{{ item.content }}"
    status_code: 204
    validate_certs: "{{ not vault_skip_verify | default(true) }}"
  loop: "{{ all_policies }}"
  when:
    - all_policies is defined
    - (item.name not in (existing_policies.json.data.keys | default([]))) or (vault_policies_update_existing | default(false))
  register: policy_creation_result

- name: Get updated policies list
  uri:
    url: "{{ vault_addr }}/v1/sys/policies/acl"
    method: LIST
    headers:
      X-Vault-Token: "{{ vault_root_token }}"
    status_code: 200
    validate_certs: "{{ not vault_skip_verify | default(true) }}"
  register: final_policies

- name: Display policy management summary
  debug:
    msg: |
      Policy Management Summary:
      - Total policies configured: {{ all_policies | length }}
      - Policies in Vault: {{ final_policies.json.data.keys | length }}
      - Policy names: {{ final_policies.json.data.keys | sort }}
  when:
    - all_policies is defined
    - final_policies.json is defined

- name: Create policy usage examples
  copy:
    content: |
      # Vault Policy Usage Examples

      # Assign policy to userpass user:
      vault write auth/userpass/users/myuser policies=app-secrets

      # Assign policy to AppRole:
      vault write auth/approle/role/myrole policies=app-secrets

      # Test policy with token:
      vault token create -policy=app-secrets

      # View policy content:
      vault policy read app-secrets

      # List all policies:
      vault policy list
    dest: "{{ vault_policies_source_dir }}/USAGE_EXAMPLES.md"
    mode: "0644"
  delegate_to: localhost
  run_once: true
