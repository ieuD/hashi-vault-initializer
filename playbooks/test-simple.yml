---
# Simple Test Environment Playbook - Dev Vault (No Sudo Required)
# ================================================================

- name: Configure Test Environment - Dev Vault (Simple)
  hosts: vault_dev
  gather_facts: yes
  become: no
  vars:
    vault_addr: "http://localhost:8200"
    vault_root_token: "myroot"

  pre_tasks:
    - name: Display test environment info
      debug:
        msg: |
          Configuring Dev Vault Test Environment (Simple)
          ==============================================
          Vault Address: {{ vault_addr }}
          Root Token: {{ vault_root_token }}
          Environment: Development/Testing (No Sudo)

    - name: Check Vault status
      uri:
        url: "{{ vault_addr }}/v1/sys/health"
        method: GET
        status_code: [200, 429, 472, 473, 501, 503]
        validate_certs: false
      register: vault_health

    - name: Display Vault status
      debug:
        msg: "Vault Status: {{ vault_health.json | default('Unknown') }}"

  tasks:
    - name: Enable audit logging (skip directory creation)
      uri:
        url: "{{ vault_addr }}/v1/sys/audit/file_audit"
        method: PUT
        headers:
          X-Vault-Token: "{{ vault_root_token }}"
        body_format: json
        body:
          type: "file"
          description: "Test audit logging"
          options:
            file_path: "/tmp/vault-audit-test.log"
            log_raw: true
            hmac_accessor: false
        status_code: [200, 204, 400] # 400 if already exists
        validate_certs: false
      ignore_errors: yes

    - name: Create test policies
      uri:
        url: "{{ vault_addr }}/v1/sys/policies/acl/{{ item.name }}"
        method: PUT
        headers:
          X-Vault-Token: "{{ vault_root_token }}"
        body_format: json
        body:
          policy: "{{ item.content }}"
        status_code: [200, 204]
        validate_certs: false
      loop:
        - name: "test-admin"
          content: |
            path "*" {
              capabilities = ["create", "read", "update", "delete", "list", "sudo"]
            }
        - name: "test-user"
          content: |
            path "secret/data/test/*" {
              capabilities = ["create", "read", "update", "delete", "list"]
            }
            path "secret/metadata/test/*" {
              capabilities = ["list", "read"]
            }
        - name: "test-readonly"
          content: |
            path "secret/data/test/*" {
              capabilities = ["read", "list"]
            }

    - name: Enable userpass authentication
      uri:
        url: "{{ vault_addr }}/v1/sys/auth/userpass"
        method: POST
        headers:
          X-Vault-Token: "{{ vault_root_token }}"
        body_format: json
        body:
          type: "userpass"
          description: "Username/Password authentication"
        status_code: [200, 204, 400] # 400 if already exists
        validate_certs: false
      ignore_errors: yes

    - name: Create test users
      uri:
        url: "{{ vault_addr }}/v1/auth/userpass/users/{{ item.username }}"
        method: POST
        headers:
          X-Vault-Token: "{{ vault_root_token }}"
        body_format: json
        body:
          password: "{{ item.password }}"
          policies: "{{ item.policies | join(',') }}"
        status_code: [200, 204]
        validate_certs: false
      loop:
        - username: "testuser"
          password: "testpass123"
          policies: ["test-user"]
        - username: "admin"
          password: "admin123"
          policies: ["test-admin"]
        - username: "readonly"
          password: "readonly123"
          policies: ["test-readonly"]

    - name: Create test secrets
      uri:
        url: "{{ vault_addr }}/v1/{{ item.path }}"
        method: POST
        headers:
          X-Vault-Token: "{{ vault_root_token }}"
        body_format: json
        body:
          data: "{{ item.data }}"
        status_code: [200, 204]
        validate_certs: false
      loop:
        - path: "secret/data/test/database"
          data:
            username: "testdb"
            password: "testdbpass"
            host: "localhost"
            port: "5432"
        - path: "secret/data/test/api"
          data:
            api_key: "test-api-key-12345"
            endpoint: "https://api.test.com"
        - path: "secret/data/test/config"
          data:
            environment: "test"
            debug: "true"
            log_level: "debug"

  post_tasks:
    - name: Display test environment summary
      debug:
        msg: |
          ğŸ‰ Test Environment Setup Complete!
          ===================================

          ğŸŒ Web UI: http://localhost:8200/ui
          ğŸ”‘ Root Token: myroot

          ğŸ‘¥ Test Users Created:
          - testuser : testpass123 (test-user policy)
          - admin    : admin123    (test-admin policy)
          - readonly : readonly123 (test-readonly policy)

          ğŸ“‚ Test Secrets Created:
          - secret/test/database (database credentials)
          - secret/test/api      (API configuration)  
          - secret/test/config   (application config)

          ğŸ“‹ Next Steps:
          1. Open http://localhost:8200/ui
          2. Login with root token 'myroot' or test users
          3. Explore secrets under 'secret/test/'

          ğŸ“„ Audit Log: /tmp/vault-audit-test.log
