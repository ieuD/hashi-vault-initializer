---
# Test Environment Playbook - Dev Vault (Pre-initialized)
# ========================================================
# This playbook configures the dev vault which is already initialized

- name: Configure Test Environment - Dev Vault
  hosts: vault_dev
  gather_facts: yes
  become: no
  vars:
    vault_addr: "http://localhost:8200"
    vault_root_token: "myroot"
    vault_audit_log_dir: "/tmp" # Override to avoid sudo

  pre_tasks:
    - name: Display test environment info
      debug:
        msg: |
          Configuring Dev Vault Test Environment
          =====================================
          Vault Address: {{ vault_addr }}
          Root Token: {{ vault_root_token }}
          Environment: Development/Testing

  roles:
    - role: vault-audit
      tags: ["audit"]

    - role: vault-policies
      tags: ["policies"]

    - role: vault-auth
      tags: ["auth"]

  post_tasks:
    - name: Create test secrets
      uri:
        url: "{{ vault_addr }}/v1/{{ item.path }}"
        method: POST
        headers:
          X-Vault-Token: "{{ vault_root_token }}"
        body_format: json
        body:
          data: "{{ item.data }}"
        status_code: [200, 204]
        validate_certs: false
      loop: "{{ vault_test_secrets | default([]) }}"
      tags: ["secrets"]

    - name: Display test environment summary
      debug:
        msg: |
          Test Environment Setup Complete!
          ===============================

          Web UI: http://localhost:8200/ui
          Root Token: myroot

          Test Users Created:
          {% for user in vault_test_users | default([]) %}
          - {{ user.username }}: {{ user.password }} ({{ user.policies | join(', ') }})
          {% endfor %}

          Test Secrets Created:
          {% for secret in vault_test_secrets | default([]) %}
          - {{ secret.path }}
          {% endfor %}

          Try logging in with:
          - Username: testuser, Password: testpass123
          - Username: admin, Password: admin123
