---
# Test Environment Playbook - Production Vault (Needs initialization)
# ===================================================================
# This playbook initializes and configures the production-like vault

- name: Configure Test Environment - Production Vault
  hosts: vault_prod_test
  gather_facts: yes
  become: no
  vars:
    vault_addr: "http://localhost:8202"

  pre_tasks:
    - name: Display production test environment info
      debug:
        msg: |
          Initializing Production-like Vault for Testing
          =============================================
          Vault Address: {{ vault_addr }}
          Environment: Production-like Testing

  roles:
    - role: vault-init
      tags: ["init"]

    - role: vault-audit
      tags: ["audit"]

    - role: vault-policies
      tags: ["policies"]

  post_tasks:
    - name: Enable userpass authentication
      uri:
        url: "{{ vault_addr }}/v1/sys/auth/userpass"
        method: POST
        headers:
          X-Vault-Token: "{{ vault_root_token }}"
        body_format: json
        body:
          type: "userpass"
          description: "Username/Password authentication"
        status_code: [200, 204, 400] # 400 if already exists
        validate_certs: false
      tags: ["auth"]

    - name: Create admin user
      uri:
        url: "{{ vault_addr }}/v1/auth/userpass/users/admin"
        method: POST
        headers:
          X-Vault-Token: "{{ vault_root_token }}"
        body_format: json
        body:
          password: "admin123"
          policies: "admin"
        status_code: [200, 204]
        validate_certs: false
      tags: ["auth"]

    - name: Display production test environment summary
      debug:
        msg: |
          Production-like Test Environment Setup Complete!
          ==============================================

          Web UI: http://localhost:8202/ui
          Root Token: {{ vault_root_token }}
          Root Token File: {{ vault_root_token_file }}
          Unseal Keys File: {{ vault_unseal_keys_file }}

          Admin User Created:
          - Username: admin, Password: admin123

          IMPORTANT: Save the root token and unseal keys securely!
